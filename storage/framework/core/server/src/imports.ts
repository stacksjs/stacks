import type { AutoImportsOptions } from 'bun-plugin-auto-imports'
import { plugin } from 'bun'
import { path } from '@stacksjs/path'
import { autoImports, generateRuntimeIndex, generateGlobalsScript } from 'bun-plugin-auto-imports'
import { globSync } from '@stacksjs/storage'

interface ExportInfo {
  name: string
  file: string
}

function scanModelExports(dir: string): ExportInfo[] {
  const files = globSync(`${dir}/**/*.ts`, { ignore: ['**/*.d.ts', '**/index.ts'] })
  const exports: ExportInfo[] = []

  for (const file of files) {
    // For model files, use the filename as the model name
    const basename = file.split('/').pop()?.replace('.ts', '') || ''
    if (basename) {
      exports.push({ name: basename, file }) // e.g., Territory from Territory.ts
      exports.push({ name: `${basename}Model`, file }) // e.g., TerritoryModel
    }
  }

  return exports
}

/**
 * Generate runtime auto-import files for Bun runtime execution
 * This creates index files that can be imported to get all auto-imports
 */
export async function generateAutoImportFiles(): Promise<void> {
  const modelsPath = path.storagePath('framework/orm/src/models')
  const functionsPath = path.resourcesPath('functions')
  const outputDir = path.storagePath('framework/auto-imports')

  // Ensure output directory exists
  await Bun.write(`${outputDir}/.gitkeep`, '')

  // Generate runtime index for functions
  const functionsIndexPath = `${outputDir}/functions.ts`
  await generateRuntimeIndex([functionsPath], functionsIndexPath)

  // Generate runtime index for models
  const modelsIndexPath = `${outputDir}/models.ts`
  await generateRuntimeIndex([modelsPath], modelsIndexPath)

  // Generate combined index
  const combinedContent = `// Generated by bun-plugin-auto-imports
export * from './functions'
export * from './models'
`
  await Bun.write(`${outputDir}/index.ts`, combinedContent)

  // Generate globals injection script
  const globalsPath = `${outputDir}/globals.ts`
  await generateGlobalsScript(
    [functionsPath, modelsPath],
    globalsPath,
    `${outputDir}/index.ts`,
  )

  // Generate TypeScript declarations
  const dtsContent = `// Generated by bun-plugin-auto-imports
// This file provides global type declarations for auto-imported functions and models

import type * as AutoImports from './index'

declare global {
  // Re-export all types from auto-imports as globals
  export import haversineDistance = AutoImports.haversineDistance
  export import calculatePolygonArea = AutoImports.calculatePolygonArea
  export import pointInPolygon = AutoImports.pointInPolygon
  export import isClosedLoop = AutoImports.isClosedLoop
  export import simplifyTrack = AutoImports.simplifyTrack
  export import getBoundingBox = AutoImports.getBoundingBox
  export import getCentroid = AutoImports.getCentroid
  export import calculatePerimeter = AutoImports.calculatePerimeter
  export import coordinatesToGeoJson = AutoImports.coordinatesToGeoJson
  export import geoJsonToCoordinates = AutoImports.geoJsonToCoordinates
  export import boundingBoxesOverlap = AutoImports.boundingBoxesOverlap
  export import routeIntersectsPolygon = AutoImports.routeIntersectsPolygon
  export import splitPolygonByRoute = AutoImports.splitPolygonByRoute
  export import parseGpx = AutoImports.parseGpx
  export import parseGpsData = AutoImports.parseGpsData
  export import validateGpsDataForClaim = AutoImports.validateGpsDataForClaim
}

export {}
`
  await Bun.write(`${outputDir}/globals.d.ts`, dtsContent)

  console.log('Auto-import files generated successfully')
}

/**
 * Initialize auto-imports for both bundler and runtime
 */
export function initiateImports(): void {
  const modelsPath = path.storagePath('framework/orm/src/models')
  const requestsPath = path.storagePath('framework/requests')
  const functionsPath = path.resourcesPath('functions')

  // Scan models - use filename-based naming for ORM models
  const modelExports = scanModelExports(modelsPath)
  const requestExports = scanModelExports(requestsPath)

  // Build imports array for models
  const modelImports = modelExports.map(exp => ({
    from: exp.file,
    name: exp.name,
    as: exp.name,
  }))

  const requestImports = requestExports.map(exp => ({
    from: exp.file,
    name: exp.name,
    as: exp.name,
  }))

  const options: AutoImportsOptions = {
    dts: path.storagePath('framework/types/server-auto-imports.d.ts'),
    imports: [...modelImports, ...requestImports],
    // Use dirs to auto-scan and import all exports from resources/functions
    dirs: [functionsPath],
    eslint: {
      enabled: true, // TODO: not needed in production envs
      filepath: path.storagePath('framework/server-auto-imports.json'),
    },
  }

  // Register bundler plugin (for Bun bundler)
  plugin(autoImports(options))

  // Generate runtime files asynchronously
  generateAutoImportFiles().catch(err => {
    console.warn('Failed to generate auto-import files:', err)
  })
}

/**
 * Import and inject all auto-imports into globalThis for runtime access
 * Call this early in your application startup
 */
export async function injectGlobalAutoImports(): Promise<void> {
  try {
    const autoImportsPath = path.storagePath('framework/auto-imports/index.ts')
    const autoImports = await import(autoImportsPath)
    Object.assign(globalThis, autoImports)
  }
  catch (err) {
    console.warn('Failed to inject global auto-imports:', err)
  }
}
